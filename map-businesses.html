<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase.js"></script>

    <script>
        $(document).ready(function(){
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyB5w4kD4fczy7qVSDvoZLv8ks7UK3O8-ps",
                authDomain: "poo-review-4f8c8.firebaseapp.com",
                databaseURL: "https://poo-review-4f8c8.firebaseio.com",
                projectId: "poo-review-4f8c8",
                storageBucket: "",
                messagingSenderId: "884187524701"
            };
            firebase.initializeApp(config);

            var database = firebase.database();

            sessionStorage.setItem("zip", "03801");
            sessionStorage.setItem("currentBusiness", "granite state");

            //  RETRIEVE BUSINESSES BY ZIP
            const listBusinesses = function(postal) {
                var businessRef = database.ref("business");
                businessRef.orderByChild("zip").equalTo(postal).once("value", function(snapshot) {
                    // console.log(snapshot.val());
                    var obj = snapshot.val();
                    Object.keys(obj).forEach(function(element) {
                        console.log(obj[element].name);
                    })
                    // console.log(snapshot.key);
                });
            }

            //  RETRIEVE BUSINESSES BY ZIP AND DISPLAY COMMENTS
            const displayComments = function(name, postal) {
                var businessRef = database.ref("business");
                businessRef.once('value', function (snapshot) {
                    snapshot.forEach(function (childSnapshot) {
                        var childKey = childSnapshot.key;
                        var childData = childSnapshot.val();
                        if ((name === childData.name) && (postal === childData.zip)) {
                            console.log("Business Match!");
                            var commentsRef = database.ref(`/business/${childKey}/comments`);
                            commentsRef.once('value', function (snapshot) {
                                console.log("Comments:")

                                // MAKE COMMENT CARD IN THIS FOREACH LOOP
                                // you can use commentData.recommend commentData.comment commentData.dateAdded
                                snapshot.forEach(function (commentSnapshot) {
                                    var commentKey = commentSnapshot.key
                                    var commentData = commentSnapshot.val();
                                    console.log("comment key: " + commentKey);
                                    console.log(`recomend = ${commentData.recommended}\nDate Added: ${commentData.dateAdded}\nComment: ${commentData.comment}`)
                                });
                            });
                        }
                    });
                });
            } // End display comments

            listBusinesses(sessionStorage.getItem("zip"));
            displayComments(sessionStorage.getItem("currentBusiness"), sessionStorage.getItem("zip"))
            
        });//End of document.ready function
    </script>
    
</body>
</html>